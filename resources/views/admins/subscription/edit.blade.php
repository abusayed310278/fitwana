@extends('layouts.adminApp')

@section('title', 'Edit Subscription')

@section('content')
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">Edit Subscription</h1>
            <p class="mb-0">Update subscription details for {{ $subscription->user->name }}</p>
        </div>
        <div class="btn-group">
            <a href="{{ route('subscription.show', $subscription) }}" class="btn btn-info">
                <i class="fas fa-eye me-2"></i>View Details
            </a>
            <a href="{{ route('subscription.index') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to List
            </a>
        </div>
    </div>

    @if ($errors->any())
        <div class="alert alert-danger">
            <ul class="mb-0">
                @foreach ($errors->all() as $error)
                    <li>{{ $error }}</li>
                @endforeach
            </ul>
        </div>
    @endif

    <div class="row">
        <!-- Subscription Form -->
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Subscription Details</h6>
                </div>
                <div class="card-body">
                    <form action="{{ route('subscription.update', $subscription) }}" method="POST" id="subscriptionForm">
                        @csrf
                        @method('PUT')

                        <!-- User Information (Read-only) -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="alert alert-info d-flex align-items-center\">\n                                    <i class=\"fas fa-info-circle me-3\"></i>\n                                    <div>\n                                        <strong>Customer:</strong> {{ $subscription->user->name }} ({{ $subscription->user->email }})<br>\n                                        <strong>Subscription ID:</strong> {{ $subscription->stripe_id }}<br>\n                                        <strong>Created:</strong> {{ $subscription->created_at->format('M d, Y g:i A') }}\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div class=\"row\">\n                            <div class=\"col-md-6 mb-3\">\n                                <label for=\"plan_id\" class=\"form-label\">Plan</label>\n                                <select class=\"form-select\" id=\"plan_id\" name=\"plan_id\" required>\n                                    @foreach($plans as $plan)\n                                        <option value=\"{{ $plan->id }}\" \n                                                data-price=\"{{ $plan->price }}\" \n                                                data-interval=\"{{ $plan->interval }}\"\n                                                {{ $subscription->plan_id == $plan->id ? 'selected' : '' }}>\n                                            {{ $plan->name }} - ${{ $plan->price }}/{{ $plan->interval }}\n                                        </option>\n                                    @endforeach\n                                </select>\n                            </div>\n                            \n                            <div class=\"col-md-6 mb-3\">\n                                <label for=\"status\" class=\"form-label\">Status</label>\n                                <select class=\"form-select\" id=\"status\" name=\"status\" required>\n                                    <option value=\"active\" {{ $subscription->status == 'active' ? 'selected' : '' }}>Active</option>\n                                    <option value=\"trialing\" {{ $subscription->status == 'trialing' ? 'selected' : '' }}>Trialing</option>\n                                    <option value=\"past_due\" {{ $subscription->status == 'past_due' ? 'selected' : '' }}>Past Due</option>\n                                    <option value=\"canceled\" {{ $subscription->status == 'canceled' ? 'selected' : '' }}>Canceled</option>\n                                    <option value=\"unpaid\" {{ $subscription->status == 'unpaid' ? 'selected' : '' }}>Unpaid</option>\n                                </select>\n                            </div>\n                        </div>\n\n                        <div class=\"row\">\n                            <div class=\"col-md-6 mb-3\">\n                                <label for=\"trial_ends_at\" class=\"form-label\">Trial Ends At (Optional)</label>\n                                <input type=\"datetime-local\" class=\"form-control\" id=\"trial_ends_at\" \n                                       name=\"trial_ends_at\" \n                                       value=\"{{ $subscription->trial_ends_at ? $subscription->trial_ends_at->format('Y-m-d\\TH:i') : '' }}\">\n                                <div class=\"form-text\">Leave empty if no trial period</div>\n                            </div>\n                            \n                            <div class=\"col-md-6 mb-3\">\n                                <label for=\"ends_at\" class=\"form-label\">Ends At (Optional)</label>\n                                <input type=\"datetime-local\" class=\"form-control\" id=\"ends_at\" \n                                       name=\"ends_at\" \n                                       value=\"{{ $subscription->ends_at ? $subscription->ends_at->format('Y-m-d\\TH:i') : '' }}\">\n                                <div class=\"form-text\">Leave empty for recurring subscriptions</div>\n                            </div>\n                        </div>\n\n                        <!-- Status Change Reason -->\n                        <div class=\"row\" id=\"status-change-reason\" style=\"display: none;\">\n                            <div class=\"col-12 mb-3\">\n                                <label for=\"change_reason\" class=\"form-label\">Reason for Status Change</label>\n                                <textarea class=\"form-control\" id=\"change_reason\" name=\"change_reason\" rows=\"3\" \n                                          placeholder=\"Explain why you're changing the subscription status...\"></textarea>\n                            </div>\n                        </div>\n\n                        <div class=\"d-flex justify-content-between\">\n                            <button type=\"button\" class=\"btn btn-secondary\" onclick=\"history.back()\">\n                                <i class=\"fas fa-times me-2\"></i>Cancel\n                            </button>\n                            <div>\n                                @if($subscription->status == 'active')\n                                <button type=\"button\" class=\"btn btn-warning me-2\" onclick=\"cancelSubscription()\">\n                                    <i class=\"fas fa-ban me-2\"></i>Cancel Subscription\n                                </button>\n                                @endif\n                                <button type=\"submit\" class=\"btn btn-primary\">\n                                    <i class=\"fas fa-save me-2\"></i>Update Subscription\n                                </button>\n                            </div>\n                        </div>\n                    </form>\n                </div>\n            </div>\n        </div>\n\n        <!-- Subscription Info -->        <div class=\"col-lg-4\">\n            <!-- Current Plan Info -->\n            <div class=\"card shadow mb-4\">\n                <div class=\"card-header py-3\">\n                    <h6 class=\"m-0 font-weight-bold text-primary\">Current Plan</h6>\n                </div>\n                <div class=\"card-body text-center\">\n                    <h4 class=\"text-primary mb-2\">{{ $subscription->plan->name }}</h4>\n                    <h2 class=\"text-success mb-1\">${{ $subscription->plan->price }}</h2>\n                    <small class=\"text-muted\">per {{ $subscription->plan->interval }}</small>\n                    <hr>\n                    <div class=\"text-start\">\n                        <div class=\"mb-2\">\n                            <i class=\"fas fa-check text-success me-2\"></i>\n                            <span>Full access to workouts</span>\n                        </div>\n                        <div class=\"mb-2\">\n                            <i class=\"fas fa-check text-success me-2\"></i>\n                            <span>Nutrition plans & recipes</span>\n                        </div>\n                        <div class=\"mb-2\">\n                            <i class=\"fas fa-check text-success me-2\"></i>\n                            <span>Progress tracking</span>\n                        </div>\n                        <div class=\"mb-2\">\n                            <i class=\"fas fa-check text-success me-2\"></i>\n                            <span>Coach consultations</span>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <!-- Subscription Timeline -->\n            <div class=\"card shadow mb-4\">\n                <div class=\"card-header py-3\">\n                    <h6 class=\"m-0 font-weight-bold text-primary\">Subscription Timeline</h6>\n                </div>\n                <div class=\"card-body\">\n                    <div class=\"timeline\">\n                        <div class=\"timeline-item\">\n                            <div class=\"timeline-marker bg-primary\"></div>\n                            <div class=\"timeline-content\">\n                                <h6 class=\"mb-1\">Subscription Created</h6>\n                                <small class=\"text-muted\">{{ $subscription->created_at->format('M d, Y g:i A') }}</small>\n                            </div>\n                        </div>\n                        \n                        @if($subscription->trial_ends_at)\n                        <div class=\"timeline-item\">\n                            <div class=\"timeline-marker {{ $subscription->trial_ends_at->isPast() ? 'bg-secondary' : 'bg-info' }}\"></div>\n                            <div class=\"timeline-content\">\n                                <h6 class=\"mb-1\">Trial {{ $subscription->trial_ends_at->isPast() ? 'Ended' : 'Ends' }}</h6>\n                                <small class=\"text-muted\">{{ $subscription->trial_ends_at->format('M d, Y g:i A') }}</small>\n                            </div>\n                        </div>\n                        @endif\n                        \n                        @if($subscription->ends_at)\n                        <div class=\"timeline-item\">\n                            <div class=\"timeline-marker {{ $subscription->ends_at->isPast() ? 'bg-danger' : 'bg-warning' }}\"></div>\n                            <div class=\"timeline-content\">\n                                <h6 class=\"mb-1\">Subscription {{ $subscription->ends_at->isPast() ? 'Expired' : 'Expires' }}</h6>\n                                <small class=\"text-muted\">{{ $subscription->ends_at->format('M d, Y g:i A') }}</small>\n                            </div>\n                        </div>\n                        @endif\n                    </div>\n                </div>\n            </div>\n\n            <!-- Actions Card -->\n            <div class=\"card shadow\">\n                <div class=\"card-header py-3\">\n                    <h6 class=\"m-0 font-weight-bold text-warning\">\n                        <i class=\"fas fa-exclamation-triangle me-2\"></i>Quick Actions\n                    </h6>\n                </div>\n                <div class=\"card-body\">\n                    <div class=\"d-grid gap-2\">\n                        <a href=\"https://dashboard.stripe.com/subscriptions/{{ $subscription->stripe_id }}\" \n                           target=\"_blank\" class=\"btn btn-outline-primary btn-sm\">\n                            <i class=\"fab fa-stripe me-2\"></i>View in Stripe\n                        </a>\n                        \n                        @if($subscription->status == 'active')\n                        <button class=\"btn btn-outline-warning btn-sm\" onclick=\"pauseSubscription()\">\n                            <i class=\"fas fa-pause me-2\"></i>Pause Subscription\n                        </button>\n                        @endif\n                        \n                        @if($subscription->status == 'canceled')\n                        <button class=\"btn btn-outline-success btn-sm\" onclick=\"reactivateSubscription()\">\n                            <i class=\"fas fa-play me-2\"></i>Reactivate\n                        </button>\n                        @endif\n                        \n                        <button class=\"btn btn-outline-info btn-sm\" onclick=\"sendInvoice()\">\n                            <i class=\"fas fa-file-invoice me-2\"></i>Send Invoice\n                        </button>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>\n@endsection\n\n@push('styles')\n<style>\n.timeline {\n    position: relative;\n    padding-left: 20px;\n}\n\n.timeline::before {\n    content: '';\n    position: absolute;\n    left: 10px;\n    top: 0;\n    bottom: 0;\n    width: 2px;\n    background: #e3e6f0;\n}\n\n.timeline-item {\n    position: relative;\n    margin-bottom: 20px;\n}\n\n.timeline-marker {\n    position: absolute;\n    left: -15px;\n    width: 12px;\n    height: 12px;\n    border-radius: 50%;\n    border: 2px solid #fff;\n    box-shadow: 0 0 0 2px #e3e6f0;\n}\n\n.timeline-content {\n    padding-left: 15px;\n}\n</style>\n@endpush\n\n@push('scripts')\n<script>\n// Store original status for comparison\nconst originalStatus = '{{ $subscription->status }}';\n\n$(document).ready(function() {\n    // Show reason field when status changes\n    $('#status').on('change', function() {\n        if ($(this).val() !== originalStatus) {\n            $('#status-change-reason').show();\n            $('#change_reason').prop('required', true);\n        } else {\n            $('#status-change-reason').hide();\n            $('#change_reason').prop('required', false);\n        }\n    });\n});\n\nfunction cancelSubscription() {\n    if (confirm('Are you sure you want to cancel this subscription? This action cannot be undone.')) {\n        $('#status').val('canceled');\n        $('#status-change-reason').show();\n        $('#change_reason').prop('required', true).val('Subscription canceled by admin');\n        \n        // Set end date to now\n        const now = new Date();\n        const formattedDate = now.toISOString().slice(0, 16);\n        $('#ends_at').val(formattedDate);\n    }\n}\n\nfunction pauseSubscription() {\n    alert('Pause functionality would integrate with Stripe to pause the subscription.');\n}\n\nfunction reactivateSubscription() {\n    if (confirm('Are you sure you want to reactivate this subscription?')) {\n        $('#status').val('active');\n        $('#ends_at').val(''); // Remove end date\n        $('#status-change-reason').show();\n        $('#change_reason').prop('required', true).val('Subscription reactivated by admin');\n    }\n}\n\nfunction sendInvoice() {\n    alert('Send invoice functionality would integrate with Stripe to send an invoice to the customer.');\n}\n</script>\n@endpush", "original_text": ""}]
